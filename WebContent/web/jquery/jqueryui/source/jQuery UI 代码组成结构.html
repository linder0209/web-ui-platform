<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>jQuery UI 源码分析 —— jQuery UI 代码组成结构</title>
        <link rel="stylesheet" href="../../../../platform/css/base.css" type="text/css"/>
        <link rel="stylesheet" href="../../../../platform/css/platform.css" type="text/css"/>
        <link rel="stylesheet" href="../../../../platform/css/theme/skyblue.css" type="text/css"/>
        <link rel="stylesheet" href="../../../../platform/css/web.css" type="text/css"/>
    </head>
    <body>
        <h3 class="h-web-paragraph-title">目录</h3>
        <ol class="h-web-catalogue">
            <li><a paragraph="1" href="#">UI Core</a></li>
            <li><a paragraph="2" href="#">Utilities</a></li>
            <li><a paragraph="3" href="#">Widgets</a></li>
        </ol>
        <div class="h-web-paragraph">
            <h3 paragraph="1">UI Core</h3>
            <p>说明：下面书写的内容是基于jQuery UI 1.9.2</p>
            <p>首先看源文件jquery.ui.core.js，该文件中定义了以下api</p>
            <h4>scrollParent()方法</h4>
            <p>Get the closest ancestor element that is scrollable.</p>
            <p>返回某一元素有滚动条的最近祖先节点。</p>
            <p>如果该元素position为fixed或直接父节点没有滚动条，则该元素有滚动条的父节点为document<br>
            </p>
            <p>判断直接父节点是否有滚动条分为两种情况，一种是该元素有定位，另一种没有定位，如果是定位，除了判断祖先节点overflow的设置，还需加上定位判断，否则直接判断祖先节点的overflow设置。这里ie与其他浏览器有所不同。</p>
            <p class="h-web-font-red"><em>Note: This method only works on jQuery objects containing one element.</em></p>
            <h4>zIndex()方法</h4>
            <p>Get the z-index for an element.</p>
            <p>设置或返回元素的zIndex，注意，如果当前元素没有定位（即position不是fixed、relative和absolute）会查找其有定位的祖先节点的zIndex</p>
            <h4>uniqueId()方法</h4>
            <p>Generate and apply a unique id for the set of matched elements.</p>
            <p>如果元素没有属性id，则设置其id属性值，是以ui-id-开头的</p>
            <h4>removeUniqueId()方法</h4>
            <p paragraph="1">Remove ids that were set by .uniqueId() for the set of matched elements.</p>
            <p paragraph="1">删除元素的id属性值，注意只删除uniqueId方法加入的id，本身存在的id不删除</p>
            <h4>选择器（selectors） :data() Selector、:focusable Selector 和 :tabbable Selector</h4>
            <p>第一个匹配指设置了data的元素；第二个是匹配可以获取焦点的dom元素，匹配规制为：首先该元素可见（即该元素或祖先元素没有设置display为none，并且该元素也不是input为hidden的元素，这种情况的判断是通过$.expr.filters.visible( element )来实现的；再就是该元素以及祖先元素的visibility不能为hidden），其次如果元素为input|select|textarea|button|object，则需判断是否设置了disabled ，如果是a标签，则需判断是否设置了href或tabIndex，对于其他html标签，则只需判断是否设置了tabIndex即可。最后一个匹配规制是在第二个基础上必须设置了tabIndex属性。</p>
            <p>看以下例子</p>
            <pre>$( ":data(color)" ).each(function() {<br>var element = $( this );<br>element.css( "backgroundColor", element.data( "color" ) );<br>});</pre>
          <pre>&lt;div&gt;&lt;input value="text input"&gt;&lt;/div&gt;<br>&lt;div&gt;&lt;a&gt;anchor without href&lt;/a&gt;&lt;/div&gt;<br>&lt;div&gt;&lt;a href="#"&gt;anchor with href&lt;/a&gt;&lt;/div&gt;<br>&lt;div&gt;&lt;p&gt;paragraph without tabindex&lt;/p&gt;&lt;/div&gt;<br>&lt;div&gt;&lt;p tabindex="1"&gt;paragraph with tabindex&lt;/p&gt;&lt;/div&gt;
$( ":focusable" ).css( "border-color", "red" );//1 3 5 匹配成功</pre>
            <pre>&lt;div&gt;&lt;input value="no tabindex"&gt;&lt;/div&gt;<br>&lt;div&gt;&lt;input tabindex="5" value="positive tabindex"&gt;&lt;/div&gt;<br>&lt;div&gt;&lt;input tabindex="-1" value="negative tabindex"&gt;&lt;/div&gt;
$( ":tabbable" ).css( "border-color", "red" );// 1 2 匹配成功，不设置tabindex时也匹配成功</pre>
             <h4>disableSelection和enableSelection方法</h4>

            <p>禁止鼠标选择和解除鼠标选择</p>
            <h4>jQuery ui plugin</h4>
            <p>$.ui.hasScroll : function( el, a )</p>
            <p>判断元素el是否有滚动条，默认判断垂直滚动条，a设为left则判断横向滚动条</p>
            <p>$.ui.hasScroll.isOver: function( y, x, top, left, height, width ) </p>
            <p>判断坐标x，y是否落在了给定的坐标范围内</p>
            
          <h3 paragraph="2">Utilities</h3>
            
            <p>该模块中包含了jquery.ui.position.js、jquery.ui.widget.js和jquery.ui.mouse.js</p>
            <p>1、首先看源文件jquery.ui.position.js，该文件中主要围绕$.fn.position（该方法扩展了jQuery中的$.fn.position）展开。<span class="h-web-font-red">该文件可脱离jquery ui 单独作为工具类使用</span>。</p>
            <h4>$.position.scrollbarWidth()</h4>
          <p>返回滚动条的宽度，该方法只会计算一次，会吧计算的结果缓存到变量中，计算的过程中动态插入了可滚动的div来辅助计算。</p>
            <h4>$.position.getScrollInfo: function( within ) </h4>

            <p>返回元素垂直和水平滚动条的宽度，返回值格式为：{width:0,height:0}。该方法传入的参数within需要调用$.position.getWithinInfo(element)包装一下。</p>
            <h4>$.fn.position(options ) </h4>
            <p>设置一个元素相对于另一个元素的位置坐标</p>
            <p>参数options有以下几个选项</p>
            <p>my：设置该元素定位的参照点，是以该元素来计算坐标的。默认值为: 'center'，相当于'center center'，该选项中有两个值，前一个值指水平方向，后一个指垂直方向。A single value such as "right" will be normalized to "right center", "top" will be normalized to "center top"，还可以设置为以下值："right+10 top-25%"。</p>
          <p>at：设置该元素要定位的坐标点，是以目标元素来计算的。默认值为: 'center'，可设置的值与<span class="h-web-font-red">'my'</span>中一样。</p>
          <p>of：指参照的目标元素，Type: <a href="http://api.jquery.com/Types#Selector" target="_blank">Selector</a> or <a href="http://api.jquery.com/Types#Element" target="_blank">Element</a> or <a href="http://api.jquery.com/Types#jQuery" target="_blank">jQuery</a> or <a href="http://api.jquery.com/Types#Event" target="_blank">Event</a>，默认值为null，如果为null则调用jQuery中的方法$.fn.position返回该元素坐标值。</p>
          <p>collision：当元素坐标超出window窗口时所采取的策略，有以下几种：flip，翻转（投影）；fit，远离窗口边缘，flipfit，首先翻转，再远离；none，不检测。默认值为"flip"</p>
          <p>using：可以设置该选项，传入回调函数</p>
          <p>within：碰壁检查参考的DOM元素，指collision的参考值。Type: Selector or Element or jQuery</p>
          
          
          <h4>$.support.offsetFractions</h4>
          <p>判断css设置像素值是否支持小数</p>
          <p>2、下面看jquery.ui.widget.js文件</p>
          <h4>$.widget = function( name, base, prototype )</h4>
          <p>该方法提供了创建jQuery UI的工厂方法，核心是创建构造方法并利用桥接方法组装到$对象中。以下是核心代码</p>
          <pre>        //构造函数，分两种情况，直接new constructor，或者调用父类中_createWidget<br>        constructor = $[ namespace ][ name ] = function(options, element) {        <br>            if (!this._createWidget) {<br>                return new constructor(options, element);<br>            }<br>            if (arguments.length) {<br>                this._createWidget(options, element);<br>            }<br>        };</pre>
          <pre>        //把相关的属性和方法赋给constructor.prototype，主要是父类$.Widget.prototype
        //和子类自定义的prototype，还有自己扩展的几个属性<br>        constructor.prototype = $.widget.extend(basePrototype, {<br>            widgetEventPrefix: existingConstructor ? basePrototype.widgetEventPrefix : name<br>        }, prototype, {<br>            constructor: constructor,<br>            namespace: namespace,<br>            widgetName: name,<br>            widgetBaseClass: fullName,<br>            widgetFullName: fullName<br>        });</pre>
          <pre>        //把构造函数和组件名桥接，即关联起来<br>        $.widget.bridge(name, constructor);</pre>
          <p>下面看一下$.widget.bridge的代码</p>
          <pre>    /**<br>     * 把插件名name和构造函数object桥接起来，并放入到$.fn中<br>     * 这样jQuery实例化就能直接调用该方法，比如dialog<br>     * $('#dialog1').dialog();<br>     * @param {type} name<br>     * @param {type} object<br>     * @returns {}<br>     */<br>    $.widget.bridge = function(name, object) {<br>        var fullName = object.prototype.widgetFullName || name;<br>        $.fn[ name ] = function(options) {<br>            var isMethodCall = typeof options === "string",<br>                    args = slice.call(arguments, 1),<br>                    returnValue = this;<br><br>            // allow multiple hashes to be passed on init<br>            //把所有传入的arguments参数放到options中<br>            options = !isMethodCall &amp;&amp; args.length ?<br>                    $.widget.extend.apply(null, [options].concat(args)) :<br>                    options;<br><br>            if (isMethodCall) {//调用方法、事件、设置属性等<br>                this.each(function() {<br>                    var methodValue,<br>                            instance = $.data(this, fullName);<br>                    if (!instance) {<br>                        return $.error("cannot call methods on " + name + " prior to initialization; " +<br>                                "attempted to call method '" + options + "'");<br>                    }<br>                    if (!$.isFunction(instance[options]) || options.charAt(0) === "_") {<br>                        return $.error("no such method '" + options + "' for " + name + " widget instance");<br>                    }<br>                    methodValue = instance[ options ].apply(instance, args);<br>                    if (methodValue !== instance &amp;&amp; methodValue !== undefined) {<br>                        returnValue = methodValue &amp;&amp; methodValue.jquery ?<br>                                returnValue.pushStack(methodValue.get()) :<br>                                methodValue;<br>                        return false;<br>                    }<br>                });<br>            } else {//直接实例化，或调用实例化对象<br>                this.each(function() {<br>                    var instance = $.data(this, fullName);<br>                    if (instance) {//如果该实例已创建，则直接调用_init方法<br>                        instance.option(options || {})._init();<br>                    } else {//否则创建并且放到data hash中<br>                        $.data(this, fullName, new object(options, this));<br>                    }<br>                });<br>            }<br><br>            return returnValue;<br>        };<br>    };</pre>
          <p>看看jQuery UI提供的父类 $.Widget</p>
          <pre>//定义了创建组件的公共方法<br>    $.Widget = function( /* options, element */ ) {<br>    };<br>    $.Widget._childConstructors = [];<br><br>    $.Widget.prototype = {<br>        widgetName: "widget",<br>        widgetEventPrefix: "",<br>        defaultElement: "&lt;div&gt;",<br>        options: {//默认提供了两个属性<br>            disabled: false,<br>            // callbacks<br>            create: null<br>        },<br>        /**<br>         * 创建组件会调用该方法<br>         * @param {type} options<br>         * @param {type} element<br>         */<br>        _createWidget: function(options, element) {<br>            element = $(element || this.defaultElement || this)[ 0 ];<br>            this.element = $(element);<br>            this.uuid = uuid++;<br>            this.eventNamespace = "." + this.widgetName + this.uuid;<br>            this.options = $.widget.extend({},<br>                    this.options,<br>                    this._getCreateOptions(),<br>                    options);<br><br>            this.bindings = $();<br>            this.hoverable = $();<br>            this.focusable = $();<br><br>            if (element !== this) {<br>                // 1.9 BC for #7810<br>                // TODO remove dual storage<br>                $.data(element, this.widgetName, this);<br>                $.data(element, this.widgetFullName, this);<br>                this._on(true, this.element, {<br>                    remove: function(event) {<br>                        if (event.target === element) {<br>                            this.destroy();<br>                        }<br>                    }<br>                });<br>                //设置原生的 document和window对象，注意取法，没有直接用document和window赋值<br>                this.document = $(element.style ?<br>                        // element within the document<br>                        element.ownerDocument :<br>                        // element is window or document<br>                        element.document || element);<br>                this.window = $(this.document[0].defaultView || this.document[0].parentWindow);<br>            }<br>            //调用_create方法，这里会切换到$.each( prototype, function( prop, value ) {此处定义的方法，在此处再调用实现组件时创建的_create方法<br>            this._create();<br>            this._trigger("create", null, this._getCreateEventData());<br>            this._init();<br>        },<br>        <br>        ...<br>    };</pre>
          <p>除了代码中几个属性和方法，实现jQuery UI的关键父类还提供了以下方法，现逐一介绍</p>
          <img src="images/$.Widget.prototype类图.jpg" />
          <p>&nbsp;</p>
          <p>下面以创建ui.dialog来分析该方法的执行过程</p>
          <pre>$.widget("ui.dialog", {<br>   //...<br>});</pre>
          <p>当执行上面的方法时</p>
          <p>&nbsp;</p>
          <p>以下是代码调用过程图</p>
          <img src="images/jQuery UI组件定义类和实例化过程.jpg" />
          <p>&nbsp;</p>
          
          
          <p>&nbsp;</p>
            
            <p>参考资料</p>
            <p><a href="http://api.jqueryui.com/" target="_blank">jQuery UI API</a></p>
        </div>
    </body>
</html>